## 系统设计步骤
1. 确定系统的功能性需求
2. 确定数据库的模式，确定数据的读写量；读写上是否有偏重
## 缓存
负载平衡可帮助您在不断增加的服务器数量上进行水平扩展，但缓存将使您能够更好地利用现有资源，并使原本无法实现的产品需求变得可行。缓存得益于，最近请求的数据有可能会被在此请求到。缓存更像是短期的内存，它有着一定的内存空间，它里面包含着最近最近受到访问的文件或是服务，它有着比原始资源更快的访问速度。缓存存在于一个结构的各个层次，但是它们更容易在更接近前端的位置被访问到。这是因为，在更接近前端层的位置实现了数据的返回，防止了对更下层造成负担。

- CDN
    - CDN 是一种缓存，适用于提供大量静态媒体的站点。在典型的 CDN 设置中，请求将首先向 CDN 询问一段静态媒体；如果该内容在本地可用，CDN 将提供该内容。如果它不可用，CDN 将查询后端服务器以获取文件，将其缓存在本地，并将其提供给请求用户。

    - 如果我们正在构建的系统不够大，无法拥有自己的 CDN，我们可以通过使用像 Nginx 这样的轻量级 HTTP 服务器从单独的子域（例如，static.yourservice.com）提供静态媒体来简化未来的过渡，并剪切- 稍后通过 DNS 从您的服务器到 CDN。
- 缓存失效
    缓存的一个问题是，当真实资源被修改了的时候，缓存的数据应该失效，否则会造成数据冲突的问题（违背一致性）。以下是几种解决办法：
    - 直写缓存
        - 数据同时写入缓存和相应的数据库，该方案可确保在崩溃、电源故障或其他系统中断的情况下不会丢失任何内容。

        - 虽然直写将数据丢失的风险降到最低，但由于每次写操作必须完成两次才能将成功返回给客户端，因此该方案具有写操作延迟较高的缺点
    - 写回缓存
        - 这种技术类似于直写缓存，但数据直接写入永久存储，绕过缓存。这可以减少缓存被写入操作淹没的情况，这些操作随后不会被重新读取，但缺点是对最近写入的数据的读取请求会造成“缓存未命中”，并且必须从较慢的后端存储和经验中读取更高的延迟
    - 回写缓存
        - 在这种方案下，数据单独写入缓存，完成后立即向客户端确认。在指定的时间间隔或在某些条件下完成对永久存储的写入。这导致写入密集型应用程序的低延迟和高吞吐量；然而，这种速度带来了在崩溃或其他不利事件的情况下数据丢失的风险，因为写入数据的唯一副本在缓存中。
- 缓存驱除策略
    - FIFO
    - LIFO
    - LRU
    - LFU
    - MRU 与LRU相反，丢弃最近使用最多的个体
    - LFU 计算需要物品的频率。那些最不常用的首先被丢弃。
    - RR 随机替换
## 数据分区
数据分区是一种将大型数据库 (DB) 分成许多较小部分的技术。它是跨多台机器拆分 DB/表以提高应用程序的可管理性、性能、可用 ​​ 性和负载平衡的过程。之所以要使用数据分区，是因为当系统规模达到某个点之后，通过添加更多机器进行水平扩展比通过添加更强大的服务器来垂直扩展更便宜和更可行。
- 分区方法
    - 水平分区
        - 在这个方案中，我们将不同的行放入不同的表中。例如如果我们将不同的地点存储在一张表中，我们可以决定将邮政编码小于 10000 的地点存储在一张表中，并将邮政编码大于 10000 的地点存储在单独的表中。这也称为基于范围的分区，因为我们将不同范围的数据存储在单独的表中。水平分区也称为数据分片。

        - 这种方法的关键问题是，如果不仔细选择用于分区范围的值，那么分区方案将导致各个服务器的负载不平衡。在前面的示例中，根据邮政编码拆分表，是基于人口按照邮政编码均匀分布来划分的。但是这种假设很有可能是无效的，因为与郊区城市相比，像曼哈顿这样人口稠密的地区会有更多的人口。
    - 垂直方区
        - 数据划分为在他们自己的服务器中存储与特定功能相关的表；例如构建一个类似Instagram的应用程序，我们可以决定将用户个人资料信息放在一个数据库服务器上，将朋友列表放在另一个服务器上，以及照片在第三台服务器上。
        - 这种方法的主要问题是，如果我们的应用程序经历了额外的增长，那么可能需要在不同的服务器上进一步对特定于功能的数据库进行分区（例如，单个服务器不可能处理 100 亿的所有元数据查询） 1.4 亿用户的照片）。    
- 分区标准
    - 基于键或Hash分区
## 索引
在数据库中的特定表上创建索引的目标是更快地搜索表并找到我们想要的一行或多行。可以使用数据库表的一列或多列创建索引，为快速随机查找和有效访问有序记录提供基础。

索引可以大大加速数据检索的过程，但是由于额外的键的产生，这也可能会导致数据插入和更新速度的降低。
在为具有活动索引的表添加行或更新现有行时，我们不仅必须写入数据，还必须更新索引。这会降低写入性能。这种性能下降适用于表的所有插入、更新和删除操作。因此，应避免在表上添加不必要的索引，并应删除不再使用的索引。重申一下，添加索引是为了提高搜索查询的性能。如果数据库的目标是提供一个经常写入而很少读取的数据存储，在这种情况下，降低更常见的操作（即写入）的性能可能不值得我们从中获得的性能提升读。

## 代理
代理服务器是客户端和后端服务器之间的中间服务器。客户端连接到代理服务器以请求诸如网页、文件、连接等服务。简而言之，代理服务器是一种软件或硬件，充当客户端请求从其他服务器寻求资源的中介.

通常，代理用于过滤请求、记录请求或有时转换请求（通过添加/删除标头、加密/解密或压缩资源）。代理服务器的另一个优点是它的缓存可以处理大量请求。如果多个客户端访问特定资源，代理服务器可以缓存它并将其提供给所有客户端，而无需前往远程服务器。

- 代理服务器类型
    - 开放代理
        - 一个开放代理是一个代理服务器，它是任何互联网用户访问。一般情况下，代理服务器只允许网络群组内的用户（即封闭代理）存储和转发 DNS 或网页等互联网服务，以减少和控制群组使用的带宽。但是，通过开放代理，Internet 上的任何用户都可以使用此转发服务。有两种著名的开放代理类型：
        1. 匿名代理- 该代理会显示其作为服务器的身份，但不会透露最初的 IP 地址。虽然这个代理服务器很容易被发现，但它可能对某些用户有利，因为它隐藏了他们的 IP 地址。
        2. 透明代理——这个代理服务器可以自我识别，并且在 HTTP 标头的支持下，可以查看第一个 IP 地址。使用这种服务器的主要好处是它能够缓存网站。

    - 反向代理
        - 一个反向代理从一个或多个服务器代表客户端检索资源。然后这些资源返回给客户端，看起来好像它们来自代理服务器本身。


## 冗余和复制
冗余是系统的关键组件或功能的复制，旨在提高系统的可靠性，通常以备份或故障安全的形式，或提高实际系统性能。例如，如果单个服务器上只存储了一个文件副本，那么丢失该服务器就意味着丢失该文件。由于丢失数据很少是一件好事，我们可以创建文件的重复或冗余副本来解决这个问题。

冗余在消除系统中的单点故障方面起着关键作用，并在危机中需要时提供备份。例如，如果我们有两个在生产环境中运行的服务实例并且一个出现故障，系统可以故障转移到另一个。

复制意味着共享信息以确保冗余资源（例如软件或硬件组件）之间的一致性，以提高可靠性、容错性或可访问性。

复制广泛用于许多数据库管理系统 (DBMS)，通常在原始和副本之间具有主副本关系。主服务器获取所有更新，然后传递到副本服务器。每个副本输出一条消息，说明它已成功接收更新，从而允许发送后续更新。

## 数据库选择
NoSQL和SQL数据库各有优劣，没有一劳永逸的数据库解决方案，甚至很多业务将两种数据库结合使用。
1. 需要使用NoSQL的场景
当我们应用程序的所有其他组件都快速无缝时，NoSQL 数据库可以防止数据成为瓶颈。大规模数据有助于 NoSQL 数据库取得更好效果，主要是因为它处理数据的方式与传统关系数据库不同。

- 存储通常几乎没有结构的大量数据。NoSQL 数据库对我们可以存储在一起的数据类型没有限制，并允许我们根据需要添加新类型。使用基于文档的数据库，您可以将数据存储在一个地方，而无需事先定义这些数据的“类型”。
- 充分利用云计算和存储。基于云的存储是一种出色的节省成本的解决方案，但需要将数据轻松地分布在多台服务器上以进行扩展。在现场或云中使用商用（价格合理、体积更小）的硬件可以为您省去额外软件的麻烦，而 NoSQL 数据库（如 Cassandra）旨在开箱即用地跨多个数据中心进行扩展，而不会带来很多麻烦。
- 数据规模增长快速的场景。NoSQL 对于快速开发非常有用，因为它不需要提前准备。如果您正在处理系统的快速迭代，需要对数据结构进行频繁更新，而不会在版本之间造成大量停机时间，那么关系数据库会减慢您的速度。

2. 需要使用SQL数据库的场景
    1. 需要确保ACID，ACID通过准确规定事务与数据库的交互方式来减少异常并保护数据库的完整性。 而NoSQL牺牲了ACID来提升可拓展性和速度。这导致了在金融领域，SQL数据库依旧是首选。
    2. 数据结构是结构化且稳定的，如果业务中的数据是结构化的，且数据规模没有大规模增加，则SQL数据是更优的选择。

## CAP定理 
<a src="https://www.ruanyifeng.com/blog/2018/07/cap.html">来源</a>

1998年，加州大学的计算机科学家 Eric Brewer 提出，分布式系统有三个指标。 
- Consistency
- Availability
- Partition tolerance
### Partition tolerance （分区容错）
任何分布式系统都需要至少满足这三个属性的其中两个
大多数分布式系统都分布在多个子网络。每个子网络就叫做一个区（partition）。分区容错的意思是，区间通信可能失败。比如，一台服务器放在中国，另一台服务器放在美国，这就是两个区，它们之间可能无法通信。
<img src="https://www.wangbase.com/blogimg/asset/201807/bg2018071601.png">
上图中，G1 和 G2 是两台跨区的服务器。G1 向 G2 发送一条消息，G2 可能无法收到。系统设计的时候，必须考虑到这种情况。

一般来说，分区容错无法避免，因此可以认为 CAP 的 P 总是成立。CAP 定理告诉我们，剩下的 C 和 A 无法同时做到。

### Consistency
Consistency 中文叫做"一致性"。意思是，写操作之后的读操作，必须返回该值。举例来说，某条记录是 v0，用户向 G1 发起一个写操作，将其改为 v1。
<img src="https://www.wangbase.com/blogimg/asset/201807/bg2018071602.png">
接下来，用户的读操作就会得到 v1。这就叫一致性。
<img src="https://www.wangbase.com/blogimg/asset/201807/bg2018071603.png">

问题是，用户有可能向 G2 发起读操作，由于 G2 的值没有发生变化，因此返回的是 v0。G1 和 G2 读操作的结果不一致，这就不满足一致性了。
<img src="https://www.wangbase.com/blogimg/asset/201807/bg2018071604.png">

为了让 G2 也能变为 v1，就要在 G1 写操作的时候，让 G1 向 G2 发送一条消息，要求 G2 也改成 v1。
<img src="https://www.wangbase.com/blogimg/asset/201807/bg2018071605.png">
这样的话，用户向 G2 发起读操作，也能得到 v1。

<img src="https://www.wangbase.com/blogimg/asset/201807/bg2018071606.png">

### Availability
Availability 中文叫做"可用性"，意思是只要收到用户的请求，服务器就必须给出回应。

用户可以选择向 G1 或 G2 发起读操作。不管是哪台服务器，只要收到请求，就必须告诉用户，到底是 v0 还是 v1，否则就不满足可用性。

### Consistency 和 Availability 的矛盾

一致性和可用性，为什么不可能同时成立？答案很简单，因为可能通信失败（即出现分区容错）。

如果保证 G2 的一致性，那么 G1 必须在写操作时，锁定 G2 的读操作和写操作。只有数据同步后，才能重新开放读写。锁定期间，G2 不能读写，没有可用性不。

如果保证 G2 的可用性，那么势必不能锁定 G2，所以一致性不成立。

综上所述，G2 无法同时做到一致性和可用性。系统设计时只能选择一个目标。如果追求一致性，那么无法保证所有节点的可用性；如果追求所有节点的可用性，那就没法做到一致性。
### 在什么场合，可用性高于一致性？

举例来说，发布一张网页到 CDN，多个服务器有这张网页的副本。后来发现一个错误，需要更新网页，这时只能每个服务器都更新一遍。

一般来说，网页的更新不是特别强调一致性。短时期内，一些用户拿到老版本，另一些用户拿到新版本，问题不会特别大。当然，所有人最终都会看到新版本。所以，这个场合就是可用性高于一致性。


## PACELC定理
基于CAP定理，一个分布式系统应该在一致性和可用性中做选择；ACID（Atomicity, Consistency, Isolation, Durability）数据库应该选择一致性，而BASE (Basically Available, Soft-state, Eventually consistent)应该选择可用性。 问题是CAP定理没有指定当没有网络的时候，分布式系统该如何做网络分区（partition）。

解决办法则来自于PACELC定理，该定理规定：
- 如果这里有个分区（‘P’），那么一个分布式系统可以在可用性（‘A’）和一致性（‘C’）之间作平衡；
- 如果没有（‘E’），当系统运行在缺少分区的情况下，系统可以在Latecncy（‘L’）和一致性之间作权衡（’C‘）。

第一部分PAC即是CAP定理，后半部分拓展到了ELC。整个理论是设想我们通过复制维护了高可能性。所以，当系统出现错误的时候，CAP理论更好用；如果没有出现错误，我们仍然必须考虑复制系统的一致性和延迟之间的权衡。
- 例子
- Dynamo 和 Cassandra是 PA/EL 系统：当分区发生时，他们选择可用性而不是一致性；否则，他们选择较低的延迟。
BigTable 和 HBase是 PC/EC 系统：他们总是会选择一致性，放弃可用性和更低的延迟。
- 可以将MongoDB视为 PA/EC（默认配置）：MongoDB 在主/辅助配置中工作。在默认配置中，所有写入和读取都在主节点上执行。由于所有复制都是异步完成的（从主节点到辅助节点），当存在主节点丢失或在少数方孤立的网络分区时，有可能丢失未复制到辅助节点的数据，因此存在丢失分区期间的一致性。因此可以得出结论，在网络分区的情况下，MongoDB 选择可用性，否则保证一致性。或者，当 MongoDB 配置为在多数副本上写入并从主副本读取时，它可以归类为 PC/EC。